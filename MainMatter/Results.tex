\chapter{Experimentaci\'on y resultados}\label{chapter:results}
En este cap\'itulo se muestran los resultados de la experimentaci\'on realizada con el esquema de restauraci\'on propuesto en el Cap\'itulo \ref{chapter:scheme}, sobre una serie de im\'agenes digitales tomadas de ciertas colecciones de inter\'es. La implementaci\'on usada es la presentada en el Cap\'itulo \ref{chapter:code}, donde adem\'as se sugiri\'o la estrategia de realizar restauraciones consecutivas que aprovechan la restauraci\'on anterior. La efectividad de la estrategia mencionada se mide de conjunto con la calidad de las restauraciones. Con el objetivo de establecer comparativas, se realizaron otros dos tipos de restauraciones sobre las mismas im\'agenes. Para distinguir del resto la restauraci\'on propuesta en este trabajo, se usan en su lugar las siglas \SOP a modo de abreviaci\'on.

Como primera restauraci\'on de referencia se cuenta con el trabajo realizado por Alexandru Telea en 2004 \cite{telea2004image}. Como se mencion\'o brevemente en la Introducci\'on, esta restauraci\'on se basa en el m\'etodo \textit{fast marching}. La idea principal es propagar la informaci\'on desde la frontera de las zonas incompletas hacia su interior, completando cada p\'ixel usando un promedio con pesos de los elementos en su vecindad de radio dado. Una vez que se restaura un p\'ixel, se mueve al siguiente usando el m\'etodo \textit{fast marching}. Para referirse a esta restauraci\'on se usan las siglas \TELEA en su lugar.

El segundo tipo de restauraci\'on se trata del desarrollado por los autores Bertalmio, Marcelo, Andrea L. Bertozzi, y Guillermo Sapiro alrededor del año 2001 \cite{bertalmio2001navier}. Se debe recordar que este trabajo est\'a basado en las ecuaciones en derivadas parciales (\textbf{EDP}) de la din\'amica de fluidos. Considerándose una heur\'istica, la estrategia es viajar por los bordes de las zonas completas hacia las zonas incompletas. Se siguen las \textit{isofotos}\footnote{Curvas o contornos que conectan puntos con igual brillo o intensidad} en la medida que coincidan con los vectores gradientes de la frontera de la subregi\'on que se va a restaurar. Para ello se emplean algunos m\'etodos de la din\'amica de fluidos. Una vez obtenido el conjunto de puntos a restaurar, los mismos se completan con valores que reducen la varianza m\'inima en su vecindad de radio dado. An\'alogamente, para abreviar el nombre de este esquema, se usa \NS en su lugar.

Las implementaciones de ambas se encuentran en forma de herramienta de \texttt{OpenCV} lo que facilit\'o su aplicaci\'on. El m\'etodo de \texttt{OpenCV}, \texttt{cv2.inpainting}, recibe 4 par\'ametros: la imagen a restaurar, la m\'ascara que define los p\'ixeles faltantes, el param\'etro entero \texttt{radius} y el par\'ametro \texttt{flag}. Para realizar una restauraci\'on del tipo \TELEA se usa \texttt{cv2.INPAINT\_TELEA} como valor del par\'ametro \texttt{flag}. En cambio si se desea usar \NS debe asignarse \texttt{cv2.INPAINT\_NS}. El valor del par\'ametro \texttt{radius} define el valor del radio de vecindad a usar en \TELEA o \NS tal como se resumi\'o en sus breves descripciones.

La experimentaci\'on, en este trabajo, se divide en dos casos de estudio. En el primer caso se trabaja con im\'agenes conocidas. Es decir, cada imagen original se corrompe intencionalmente, y se realizan las restauraciones sobre las im\'agenes corruptas. Finalmente tomando las imagenes restauradas, cada una de ellas se compara con la original usando determinada m\'etrica. La m\'etrica seleccionada es la medida \PSNR \cite{enwiki:psnr}, la cual para dos im\'agenes $I$ y $C$ se define como sigue:
\begin{equation}
	\PSNR(I, C) = 10 \log_{10} \left(\frac{\textbf{MAX}^2_I}{\textbf{MCE}(I, C)}\right)
\end{equation}
donde $\textbf{MAX}_I$ es el mayor valor que puede tomar alg\'un p\'ixel de la imagen $I$ (por lo general es 255), y la funci\'on $\textbf{MCE}$ es el error cuadr\'atico medio que se calcula como:
\begin{equation}
	\textbf{MCE}(I, C) = \frac{1}{ab}\sum_{i=1}^{a}\sum_{j=1}^{b}[I(i, j) - C(i, j)]^2
\end{equation}
donde $a \times b$ es la dimensi\'on de ambas im\'agenes. Por ejemplo, si se tiene un error pequeño como $\textbf{MCE}(I, C) = 50$, entonces: $$\PSNR(I, C) = 10 \log_{10} \left(\frac{\textbf{MAX}^2_I}{50}\right) \approx 31.14$$ cuando se trata de de p\'ixeles en el rango est\'andar de $[0,\;255]$. En cambio, para un error mucho mayor como $\textbf{MCE}(I, C) = 5000$, resulta en $$\PSNR(I, C) = 10 \log_{10} \left(\frac{\textbf{MAX}^2_I}{5000}\right) \approx 11.14$$ esto significa que la m\'etrica \PSNR de dos im\'agenes es inversamente proporcional a su error cuadr\'atico medio. En sentido general, altos valores de $\PSNR(I, C)$ indican que $C$ es una reconstrucción fiel a $I$. Esta medida tambi\'en se encuentra implementada de forma eficiente en \texttt{OpenCV}, mediante la funci\'on \texttt{cv2.PSNR} que recibe como par\'ametros las matrices de las im\'agenes.

En el segundo caso de estudio se trabaja con im\'agenes que inicialmente cuentan con zonas incompletas, con lo cual se desconoce la imagen real. En este escenario no es posible utilizar m\'etricas para medir la calidad de las restauraciones. Por lo tanto todo tipo de consideraciones sobre los resultados ser\'an meramente visuales y subjetivas. Sin embargo, las restauraciones \TELEA y \NS que ya son conocidas y han sido utilizadas para resolver dis\'imiles problem\'aticas, ser\'an de mucha utilidad en esta situaci\'on. La intenci\'on en este caso de estudio tambi\'en es analizar las ventajas y desventajas de la restauraci\'on \SOP en el campo de las  im\'agenes medicas.

\section{Caso de estudio 1: Restauraci\'on conociendo la imagen original}

Descripci\'on general del experimento:
\begin{itemize}
	\item Las im\'agenes a utilizar son tomadas de la conocida colecci\'on de \textit{Berkeley}, en escala de grises y con mediana o pequeña resoluci\'on.
	\item Se consideraron 26 im\'agenes, de ellas:
	\begin{itemize}
		\item Conforman el grupo (A): 12 im\'agenes de dimensi\'on $512 \times 512$.
		\item Conforman el grupo (B): 14 im\'agenes, 11 de dimensi\'on $312 \times 418$, y 3 de $418 \times 312$.
	\end{itemize}
	\item Las m\'ascaras utilizadas para generar las im\'agenes corruptas son las mismas para las im\'agenes de igual dimensión.
	\begin{table}[H]
		\centering
		\begin{tabular}{|l|ccc|}\hline
		Resoluci\'on & $512 \times 512$ & $321 \times 481$ & $481 \times 321$ \\
		M\'ascara &
		\includegraphics[scale=0.2]{Experiments/Berkeley/mask_512_512.tif} &
		\includegraphics[scale=0.2]{Experiments/Berkeley/mask_481_321.jpg} &
		\includegraphics[scale=0.2]{Experiments/Berkeley/mask_321_481.jpg} \\\hline
		\end{tabular}
	\end{table}
	Las m\'ascaras se generaron de manera aleatoria, cada p\'ixel se seleccion\'o como corrupto con probabilidad $4/5$. Como resultado, aquellos p\'ixeles donde debe realizarse la restauraci\'on representan aproximadamente el 80\% de la m\'ascara. Por lo tanto despu\'es de aplicada, la imagen corrupta resultante solo contiene un 20\% de la informaci\'on original.
	\begin{figure}[H]
		\centering
		\begin{tikzpicture}[spy using outlines]
			\node[anchor=south west,inner sep=0] (image) at (0,0) {\includegraphics[width=0.25\textwidth]{Experiments/Berkeley/mask_512_512.tif}};
			\spy [red,draw,height=0.2\textwidth,width=0.2\textwidth,magnification=32,connect spies] on (1, 1) in node at (7, 2);
		\end{tikzpicture}
		\caption{Subregi\'on ampliada de la m\'ascara de dimensi\'on $512 \times 512$. P\'ixeles blancos (valor 255) indican p\'ixeles faltantes en la imagen donde se aplique.}
		\label{fig:mask_zoom}
	\end{figure}
	
	\item Se realizaron 3 tipos diferentes de restauraciones, de la siguiente forma:
	\begin{enumerate}
		\item Restauraci\'on \SOP utilizando la estrategia de restauraciones consecutivas:
		\begin{table}[H]
			\centering
			\begin{tabular}{|c|cccc|}
				\hline
				Iteraci\'on & $K$ & $\sqrt{n}$ & $B$ & $\epsilon$ \\\hline
				1 & $10$ & $5$ & $6$ & $10^4$\\
				2 & $10$ & $4$ & $7$ & $10^6$\\
				3 & $10$ & $4$ & $8$ & $10^8$\\\hline
			\end{tabular}
			\caption{Par\'ametros para el grupo (A)}
		\end{table}
		\begin{table}[H]
			\centering
			\begin{tabular}{|c|cccc|}
				\hline
				Iteraci\'on & $K$ & $\sqrt{n}$ & $B$ & $\epsilon$ \\\hline
				1 & $10$ & $6$ & $6$ & $10^4$\\
				2 & $10$ & $5$ & $7$ & $10^6$\\
				3 & $10$ & $5$ & $8$ & $10^8$\\\hline
			\end{tabular}
			\caption{Par\'ametros para el grupo (B)}
		\end{table}
		\item Restauraci\'on usando \TELEA con radio de vecindad $8$, para ambos grupos (A) y (B).
		\item Restauraci\'on usando \NS con radio de vecindad $8$, para ambos grupos (A) y (B).
	\end{enumerate}
	\item La m\'etrica a usar para comparar los resultados de las diferentes restauraciones es la medida \textbf{PSNR}.
\end{itemize}

\input{Experiments/BerkeleyA}
\input{Experiments/BerkeleyB}
A continuaci\'on se muestran los resultados del primer experimento en las tablas \ref{tab:BerkeleyA} y \ref{tab:BerkeleyB}. En ambas tablas se resaltan por cada una de sus filas, el mayor (de color azul) y el menor valor (de color rojo) que alcanz\'o la m\'etrica.

\BerkeleyA{Medida \PSNR de los tres tipos de restauraciones en el grupo (A)}{teal}{red}
Como se puede apreciar en la tabla \ref{tab:BerkeleyA}, para todas las im\'agenes del grupo (A), la restauraci\'on de mejor calidad seg\'un la m\'etrica \PSNR es \SOP con la estrategia de restauraciones consecutivas. En cambio, la de menos calidad resulta la restauraci\'on de referencia \TELEA. Por otro lado, \NS a pesar de que muestra altos valores de la m\'etrica, tambi\'en queda por debajo de la iteraci\'on 3 de \SOP, y no muy por encima de la iteraci\'on inicial. El caso de la imagen \texttt{house.tif} es donde se alcanz\'o la mayor calidad de restauraci\'on con \SOP (ver figura \ref{fig:house.tif}), y con la imagen \texttt{walkbridge.tif} se obtuvo la peor calidad en este grupo (ver figura \ref{fig:walkbridge.tif}). Ahora bien, analizando los datos de la tabla \ref{tab:BerkeleyA_diffs} es posible observar como, en promedio, la segunda iteraci\'on aumenta la m\'etrica notablemente respecto a la primera iteraci\'on. De igual forma, pero en menor medida sucede con la tercera y la segunda. Los resultados muestran que la estrategia de restauraciones \SOP consecutivas es efectiva, sobretodo una segunda restauraci\'on es casi necesaria. Realizar 3 o m\'as depender\'a de las necesidades y poder de c\'omputo del usuario que considere oportuno y ventajoso ejecutarlas. 
\BerkeleyAdiffs{Diferencias entre promedios de las medidas \PSNR en el grupo (A)}
\newcommand\showBerkeleyRestaurations[2]{
\begin{tabular}{ccc}
	\includegraphics[width=0.25\linewidth]{Experiments/Berkeley/#1_corrupted.#2}&
	\includegraphics[width=0.25\linewidth]{Experiments/Berkeley/#1_cv2_TELEA.#2}&
	\includegraphics[width=0.25\linewidth]{Experiments/Berkeley/#1_cv2_NS.#2}\\
	\tiny{Imagen Corrupta}&\tiny{\TELEA}&\tiny{\NS}\\
	\includegraphics[width=0.25\linewidth]{Experiments/Berkeley/#1_iteration_1.#2}&
	\includegraphics[width=0.25\linewidth]{Experiments/Berkeley/#1_iteration_2.#2}&
	\includegraphics[width=0.25\linewidth]{Experiments/Berkeley/#1_iteration_3.#2}\\
	\tiny{Iteraci\'on 1}&\tiny{Iteraci\'on 2}&\tiny{Iteraci\'on 3}\\
\end{tabular}
}

\begin{figure}[H]
	\centering
	\showBerkeleyRestaurations{house}{tif}
	\caption{Restauraciones para la versi\'on corrupta de la imagen \texttt{house.tif}.}
	\label{fig:house.tif}
\end{figure}
\begin{figure}[H]
	\centering
	\showBerkeleyRestaurations{walkbridge}{tif}
	\caption{Restauraciones para la versi\'on corrupta de la imagen \texttt{walkbridge.tif}.}
	\label{fig:walkbridge.tif}
\end{figure}

\BerkeleyB{Medida \PSNR de los tres tipos de restauraciones para el grupo (B)}{teal}{red}

Los resultados del experimento con el grupo de im\'agenes (B) en la tabla \ref{tab:BerkeleyB} muestran en general una menor medida \PSNR respecto al grupo (A). Se debe recordar que la resoluci\'on de todas las im\'agenes de (B) es menor en comparaci\'on con el grupo (A). Por otro lado, puede percatarse que en el caso de (B), en la mayor\'ia de sus im\'agenes existen objetos con mucho nivel de detalle en planos alejados, en cambio, en (A) la tendencia es contener objetos en primer plano. Sin embargo, las diferencias entre los 3 tipos de restauraciones se mantuvieron de forma similar. La iteraci\'on 3 de \SOP es en general la de mayor medida \PSNR, aunque en esta ocasión no ocurrió siempre, ya que en el caso de la imagen \texttt{im16.jpg} la restauraci\'on \NS fue la mejor. Se puede apreciar tambi\'en que en la imagen \texttt{im19.jpg} la iteraci\'on 3 de \SOP fue contraproducente, pues disminuy\'o la métrica con respecto a la segunda. Nuevamente, \TELEA arroj\'o los peores resultados de la m\'etrica en general, sin dejar de destacar que la primera restauración \SOP fue la peor en 3 im\'agenes. En cuanto a las diferencias entre los promedios de la tabla \ref{tab:BerkeleyB_diffs}, se confirma la efectividad de la segunda restauraci\'on \SOP y de la estrategia en general. Tambi\'en se tiene que la brecha entre \NS y la primera iteraci\'on de \SOP es mayor con respecto a la del grupo (A), lo que implica la necesidad de hacer restauraciones \SOP consecutivas. La imagen donde se observaron las mejores m\'etricas fue \texttt{im24.jpg}, como se puede notar se trata de un objeto (ping\"uino) en un plano cercano y con poco detalle. El caso de las peores m\'etricas fue la imagen \texttt{im16.jpg}, la cual tiene un objeto (caballo) en el fondo, y le rodea un paisaje con muchos detalles.

\BerkeleyBdiffs{Diferencias entre promedios de las medidas \PSNR en el grupo (B)}

\begin{figure}[H]
	\centering
	\showBerkeleyRestaurations{im24}{jpg}
	\caption{Restauraciones para la versi\'on corrupta de la imagen \texttt{im24.jpg}.}
	\label{fig:im24.jpg}
\end{figure}
\begin{figure}[H]
	\centering
	\showBerkeleyRestaurations{im16}{jpg}
	\caption{Restauraciones para la versi\'on corrupta de la imagen \texttt{im16.jpg}.}
	\label{fig:im16.jpg}
\end{figure}

Finalmente, haciendo un an\'alisis conjunto de los resultados del experimento en ambos grupos (A) y (B), se emiten las siguientes consideraciones. Para el tipo de m\'ascara escogido, la restauraci\'on \SOP es eficaz, mejor que \TELEA en el caso de la restauraci\'on simple, y mejor que \NS cuando se llega a la tercera restauraci\'on consecutiva. Lo anterior muestra a su vez que la estrategia de restauraciones consecutivas propuesta en el ep\'igrafe \ref{sec:module_how_to_use} es igualmente efectiva. En cuanto a la selecci\'on de los par\'ametros del esquema, se aprecia que con valores relativamente pequeños para el lado del parche $\sqrt{n}$ y el radio de vecindad $B$ se obtuvieron en general altos valores de la m\'etrica \PSNR. Debe recordarse que las im\'agenes corruptas solo contienen el 20\% de su informaci\'on original. La misma, al estar distribuida de forma uniforme por toda la imagen (ver figura \ref{fig:mask_zoom}) aumenta la posibilidad de que cada parche contenga alg\'un p\'ixel con informaci\'on real, lo cual es una condici\'om favorable para el algoritmo \ref{al:PRA}. Surge la idea de, en cambio de una m\'ascara aleatoria, utilizar una m\'ascara predeterminada que siga alg\'un patr\'on que garantice que todos los parches contengan al menos un p\'ixel no faltante. Lo anterior puede resultar \'util como estrategia de compresi\'on de im\'agenes, incluso se pudiera determinar el patr\'on de la m\'ascara necesario para una raz\'on de compresi\'on deseada. 

\section{Caso de estudio 2: Restauraci\'on en im\'agenes de Colposcop\'ia}
Descripci\'on general del experimento:
\begin{itemize}
	\item En este caso se experimentan con im\'agenes de colposcop\'ia. Una colposcop\'ia es un examen que se realiza al cuello del \'utero de la mujer, tomando im\'agenes del mismo usando un colposcopio (instrumento o\'ptico preparado para este tipo de examen que monitorea determinados par\'ametros). Al inicio del proceso se aplica una solución salina con el objetivo de eliminar las secreciones del cérvix y revelar los vasos sanguíneos. Soluciones de ácido acético se aplican para identificar anomalías epiteliales que se expresan a través de una coloración blanca. Sin embargo, su diagnóstico se ve afectado por la aparición de regiones especulares, en las que se concentra el reflejo de la fuente de luz utilizada al realizar la prueba \cite{dgomez2018tesis}.
	
	\item Se seleccionaron 10 im\'agenes, todas a color, de ellas:
	\begin{itemize}
		\item Conforman el grupo (C): 5 im\'agenes de dimensi\'on $480 \times 720$.
		\item Conforman el grupo (D): 5 im\'agenes de dimensi\'on $480 \times 480$.
	\end{itemize}
	
	\item Cada imagen tiene asociada una m\'ascara que define las regiones especulares que se desean eliminar. Estas m\'ascaras fueron tomadas de trabajos anteriores, lo cuales se obtuvieron mediante el uso de filtros que detectan los p\'ixeles de brillo intenso.
	
	\item Se realizaron 3 tipos diferentes de restauraciones, de la siguiente forma:
	\begin{enumerate}
		\item Restauraci\'on \SOP utilizando la estrategia de restauraciones consecutivas:
		\begin{table}[H]
			\centering
			\begin{tabular}{|c|cccc|}
				\hline
				Iteraci\'on & $K$ & $\sqrt{n}$ & $B$ & $\epsilon$ \\\hline
				1 & $10$ & $5$ & $6$ & $10^4$\\
				2 & $10$ & $4$ & $7$ & $10^6$\\
				3 & $10$ & $4$ & $8$ & $10^8$\\\hline
			\end{tabular}
			\caption{Par\'ametros para el grupo (C)}
		\end{table}
		\begin{table}[H]
			\centering
			\begin{tabular}{|c|cccc|}
				\hline
				Iteraci\'on & $K$ & $\sqrt{n}$ & $B$ & $\epsilon$ \\\hline
				1 & $10$ & $16$ & $10$ & $10^4$\\
				2 & $10$ & $8$ & $10$ & $10^6$\\\hline
			\end{tabular}
			\caption{Par\'ametros para el grupo (D)}
		\end{table}
		\item Restauraci\'on usando \TELEA con radio de vecindad $8$, para ambos grupos (C) y (D).
		\item Restauraci\'on usando \NS con radio de vecindad $8$, para ambos grupos (C) y (D).
	\end{enumerate}
	\item Para las im\'agenes de colposcop\'ia con brillo no es posible usar alguna m\'etrica de calidad, pues se desconoce la imagen real. Todas las consideraciones ser\'an visuales y fruto de la comparativa con las restauraciones \TELEA y \NS.  
\end{itemize}

\newcommand\showColposcopyRestaurations[2]{
\begin{tabular}{ccc}
	\includegraphics[width=0.3\linewidth]{Experiments/Colposcopy/#1.#2}&
	\includegraphics[width=0.3\linewidth]{Experiments/Colposcopy/#1_cv2_TELEA.#2}&
	\includegraphics[width=0.3\linewidth]{Experiments/Colposcopy/#1_cv2_NS.#2}\\
	\tiny{Imagen de colposcop\'ia}&\tiny{\TELEA}&\tiny{\NS}\\
	\includegraphics[width=0.3\linewidth]{Experiments/Colposcopy/#1_iteration_1.#2}&
	\includegraphics[width=0.3\linewidth]{Experiments/Colposcopy/#1_iteration_2.#2}&
	\includegraphics[width=0.3\linewidth]{Experiments/Colposcopy/#1_iteration_3.#2}\\
	\tiny{Iteraci\'on 1}&\tiny{Iteraci\'on 2}&\tiny{Iteraci\'on 3}\\
\end{tabular}
}

\begin{figure}[H]
	\centering
	\showColposcopyRestaurations{5-1}{bmp}
	\caption{Restauraciones para la versi\'on corrupta de la imagen colposc\'opica \texttt{5-1.bmp}.}
	\label{fig:5-1.bmp}
\end{figure}

\begin{figure}[H]
	\centering
	\showColposcopyRestaurations{13-4}{bmp}
	\caption{Restauraciones para la versi\'on corrupta de la imagen colposc\'opica \texttt{13-4.bmp}.}
	\label{fig:13-4.bmp}
\end{figure}

\begin{figure}[H]
	\centering
	\showColposcopyRestaurations{48-1}{bmp}
	\caption{Restauraciones para la versi\'on corrupta de la imagen colposc\'opica \texttt{48-1.bmp}.}
	\label{fig:48-1.bmp}
\end{figure}

\begin{figure}[H]
	\centering
	\showColposcopyRestaurations{73-14}{bmp}
	\caption{Restauraciones para la versi\'on corrupta de la imagen colposc\'opica \texttt{73-14.bmp}.}
	\label{fig:73-14.bmp}
\end{figure}

\begin{figure}[H]
	\centering
	\showColposcopyRestaurations{82-5}{bmp}
	\caption{Restauraciones para la versi\'on corrupta de la imagen colposc\'opica \texttt{82-5.bmp}.}
	\label{fig:82-5.bmp}
\end{figure}